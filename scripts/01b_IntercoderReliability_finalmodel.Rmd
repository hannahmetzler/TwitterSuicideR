---
title: "Final intercoder reliability"
author: "Hannah Metzler"
date: "9/21/2021"
output: 
  pdf_document:
    df_print: kable
    keep_tex: true
url_colour: blue
always_allow_html: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
Sys.setlocale("LC_ALL", 'en_US.UTF-8')
options(scipen=99)
library(dplyr)
library(stringr)
library(tidyr)
library(irr)
# library(xfun)
library(caret) #confusionMatrix
# library(forcats)
# library(RColorBrewer)
```

# Final reliability round 4: 150 predicted with BERT for 5 main categories of interest

Codes by Hannah and Thomas and BERT used for the final results. Coding into the 1 small categories, but simplify to 5 main categories (Coping, Suicidality, Awareness, Prevention, Werther) before evaluating the reliability. No evaluation for the irrelevant class. 

Goal was to have at least 100 true instances for each class. 

```{r, preprocess data}
#Load and clean the data

#BERT predictions
db4 <- read.csv('../reliability_datasets/round4_150x5_suicide_withpredictions_BERT_not_finetuned.csv', stringsAsFactors = F, sep = '\t') %>% 
  mutate(predictionBERT1 = as.factor(predictionBERT1),
          id = as.character(id)) %>% 
  rename(category.BERT = predictionBERT1)
#Hannah's labels
dh4 <- read.csv('../reliability_datasets/round4_150x5_suicide_Hannah_complete_IDsrepaired.csv', stringsAsFactors = T)  %>% 
  #delete text columns, messed up by excel, use text from BERT predictions dataset. #delete text columns split into multiple columns in Hannah file
  select(-c(text, X, X.1, X.2, X.3, X.4, X.5, X.6)) %>% 
  #transform to factor
    mutate(notserious_unclear = as.factor(notserious_unclear), 
           focus = as.factor(focus), 
           type = as.factor(type)) %>% 
  mutate(time = as.character(time), 
         id = as.character(id)) %>% 
   mutate(main_category = recode(category, news_suicidality = "irrelevant", news_coping = "irrelevant", bereaved_negative = "irrelevant", bereaved_coping = "irrelevant", 
                                life_saved = "irrelevant", suicide_other = "irrelevant", "off-topic" = "irrelevant", 
                                coping1 = "coping", coping3 = "coping", suicidality1 = "suicidality", suicidality3 = "suicidality"))
#Thomas' labels
dt4 <- read.csv('../reliability_datasets/round4_150x5_suicide_Thomas_complete_IDsrepaired.csv', stringsAsFactors = F) %>%
  select(-X1.problem.1) %>% 
  #delete text columns, messed up by excel, use text from BERT predictions dataset. #delete text columns split into multiple columns in Hannah file
  select(-c(text, text.1, X, X.1, X.2, X.3, X.4, X.5, X.6)) %>% 
  rename(thomas_notes = "any.other.category.", 
         focus0 = "Focus.0..neither.problem.solution", 
         focus1 = "X1.problem", 
         focus2 = "X2.solution", 
         notserious_unclear1 = "notserious_unclear..1..includes.suicide_other.and.off.topic") %>% 
  #transform logical vectors to characters
  mutate(news.coping  = as.character(news.coping), 
         id = as.character(id))%>% 
  #rename x in all category columns to the name of the category, so they can all be merged into one column next
  mutate(Suicidality.1 = recode(Suicidality.1, x="suicidality1"), 
         Suicidality.3 = recode(Suicidality.3, x="suicidality3"), 
         Coping.1  = recode(Coping.1, x = "coping1"),
         Coping.3  = recode(Coping.3, x = "coping3" ),
         bereaved.neg  = recode(bereaved.neg, x = "bereaved_negative"), 
         bereaved.pos  = recode(bereaved.pos, x = "bereaved_coping"),
         werther  = recode(werther, x = "werther"),
         awareness  = recode(awareness, x = "awareness"), 
         prevention  = recode(prevention, x ="prevention"), 
         live.saved  = recode(live.saved, x ="life_saved"), 
         news.suicidality  = recode(news.suicidality, x ="news_suicidality"), 
         prevention  = recode(prevention, x ="prevention"), 
         news.coping  = recode(news.coping, x ="news_coping"), 
         sui.other  = recode(sui.other, x ="suicide_other"), 
         off.topic   = recode(off.topic , x ="off-topic")) %>% 
  #combine all above columns into one variable called category
  tidyr::pivot_longer(cols=c("Suicidality.1", "Suicidality.3", 
                             "Coping.1", "Coping.3", "bereaved.neg", "bereaved.pos", "werther", 
                             "live.saved", "awareness", "prevention", "news.suicidality", 
                             "news.coping", "sui.other", "off.topic"), names_to="variable", values_to="category") %>% 
  #filter all the empty lines (since only one variable has an entry (an "x))
  filter(category != "") %>% 
  select(-variable) %>%
  #repeat the same for all focus variables: recode the cells to column name
  mutate(focus0 = recode(focus0, x="0"),
         focus1= recode(focus1, x= "1"), 
         focus2= recode(focus2,x = "2")) %>% 
  #merge all into 1 column  
  tidyr::pivot_longer(cols=c("focus0", "focus1", "focus2"), names_to="variable", values_to="focus") %>% 
  filter(focus != "") %>% 
  select(-variable) %>% 
  #repeat the same for serious/unclear: recode the cells to column name
  mutate(notserious_unclear1 = recode(notserious_unclear1, x="1"),
         X0.serious= recode(X0.serious, x= "0")) %>% 
  #merge all into 1 column
  tidyr::pivot_longer(cols=c("notserious_unclear1", "X0.serious"), names_to="variable", values_to="notserious_unclear") %>% 
  select(-variable) %>% 
  filter(notserious_unclear != "") %>% 
  #format variables
  mutate(notserious_unclear = as.factor(notserious_unclear), 
           focus = as.factor(focus), 
         category = as.factor(category)) %>% 
  mutate(time = as.character(time), 
         id = as.character(id)) %>% 
  mutate(main_category = as.factor(recode(category, news_suicidality = "irrelevant", news_coping = "irrelevant", bereaved_negative = "irrelevant", bereaved_coping = "irrelevant", 
                                life_saved = "irrelevant", suicide_other = "irrelevant", "off-topic" = "irrelevant", 
                                coping1 = "coping", coping3 = "coping", suicidality1 = "suicidality", suicidality3 = "suicidality")))

#join Hannah and BERT
d4 = db4 %>% 
  inner_join(dh4, suffix = c(".bert", ".hannah"), by = "id") %>% 
  left_join(dt4, suffix = c(".hannah", ".thomas"), by = "id")
#order columns
d4 = d4[,order(colnames(d4))]
```

```{r}
#check which empty cases there are in Thomas' labels

```


# Hannah and BERT

```{r}
#filter (remove) the irrelevant category for calculating Kappa (only predictions for 5 relevant ones included in BERT)
d4r = d4 %>%  #data round 4 relevant categories only
  filter(main_category.hannah != "irrelevant") %>% 
  filter(main_category.thomas != "irrelevant") %>% 
  droplevels()

caret::confusionMatrix(d4r$category.BERT, d4r$main_category.hannah)
```

# Thomas and BERT

```{r}
confusionMatrix(d4r$category.BERT, d4r$main_category.thomas)
```

# Human inter-coder reliability

##  5 categories of interest

```{r}
confusionMatrix(d4r$main_category.hannah, d4r$main_category.thomas)
```

## 6 main categories (including irrelevant)
```{r}
#confusion matrix
confusionMatrix(d4$main_category.hannah, d4$main_category.thomas)
```
```

## 12 categories

```{r}
irr::kappa2(d4[c("category.hannah", "category.thomas")])
```



